<?php
global $st_lang;
$last_month = ($this->month == 1) ? 12 : $this->month-1;
$last_year = ($this->month == 1) ? $this->year-1 : $this->year;
$next_month = ($this->month == 12) ? 1 : $this->month+1;
$next_year = ($this->month == 12) ? $this->year+1 : $this->year;
$current_month_and_year = date("M Y", strtotime("01-".$this->month."-".$this->year));
$last_url = "/expenses/index/month/".$last_month."/year/".$last_year;
$next_url = "/expenses/index/month/".$next_month."/year/".$next_year;
?>
<script type="text/javascript" language="text/javascript">
	var deleteUrl = "<?php echo Zend_Registry::get('config')->moxie->settings->url; ?>/expenses/delete/id/";
    var deleteMessage = "<?php echo $st_lang['expenses_delete_message']; ?>";
	var tagList = [<?php if(!empty($this->tags)) echo "'".implode($this->tags, "','")."'"; ?>];
    var usedTagList = [<?php if(!empty($this->used_tag_list)) echo "'".implode($this->used_tag_list, "','")."'"; ?>];
	var tagsPlaceholder = "<?php echo $st_lang['tags_placeholder']; ?>";
</script>
<script type="text/javascript" src="/js/expenses/data.js?v=4"></script>

<?php $this->getHelper('Web')->printHeaderNextLastInterval($last_url, $next_url, $current_month_and_year); ?>

<div id="form">
<div class="form-group moxie_expenses_form_div moxie_expenses_form_left">
<?php
$i_expensePK = $this->form->getValue('id');
$checked = ($this->form->getValue('in_sum') == "1") ? "checked": "";
?>
	<?php if(isset($this->favourites_json) && $this->favourites_json != "[]") { ?>
	<div id="favourites_container">
		<button data-toggle="collapse" data-target="#favourites_list" class="btn btn-info">Favoritos</button>
		<span id="favourites_list" class="collapse">
			<script type="text/javascript">
				favourite_data = <?php echo $this->favourites_json; ?>;
			</script>
			<form class="form-group">
				<select id="favourites" name="favourites" class="form-control">
					<option value=""></option>
				</select>
			</form>
		</span>
	</div>
	<?php } ?>
	<form id="login" enctype="application/x-www-form-urlencoded" action="<?php echo $this->form->getAction(); ?>" method="<?php echo $this->form->getMethod(); ?>" class="moxie_form">
	<?php
	if (isset($i_expensePK)) {
	?>
		<input type="hidden" id="id" name="id" value="<?php echo $i_expensePK; ?>"/>
	<?php
	}
	//echo $this->form->getElement('id');
	echo $this->form->getElement('amount');
	echo $this->form->getElement('note');
	echo $this->form->getElement('date');
	echo $this->form->getElement('category');
	echo $this->form->getElement('tags');
	echo $this->form->getElement('in_sum');
	echo $this->form->getElement('favourite');
	echo $this->form->getElement('submit');
	if(isset($i_expensePK)) {
		echo '<input type="button" class="btn btn-error" value="'.$st_lang['expenses_delete'].'" onclick=\'confirmDelete("' . $i_expensePK . '")\'/>';
	}
	?>
	</form>
</div>
<div id="search_box" class="moxie_expenses_form_div moxie_expenses_form_right">
<?php
echo $this->partial('common/filter.phtml', array('search_form' => $this->search_form));
?>
</div>
</div>

<?php
$st_budget = $this->budget;

$s_out = '
<table class="table table-striped" id="mytable" width="100%">
<tr><td></td><td align="right">'.$st_lang['expenses_expended'].'</td>';
if (!empty($st_budget)) $s_out .= '<td align="right">'.$st_lang['expenses_budget'].'</td></tr>';

$st_jsonData = array();
$current = 0;
$total = 0;
$budget_total = 0;
foreach ($this->expenses as $key => $data) {
	$amount = $data['sum(e.amount)'];
	$current = $data['id'];
	$category_name = $data['name'];
	$total = $total + $amount;
	$st_jsonData[] = "['".$category_name."', ".$amount."]";
	$budget_amount = (isset($st_budget[$data['id']])) ? $st_budget[$data['id']] : 0;
	$budget_color = ($budget_amount <= $amount) ? '#FF0000' : '#00FF00';
	$s_out .= '<tr>'
			.'<td><a href="/expenses/index/category/'.$data['id'].'/month/'.$this->month.'/year/'.$this->year.'">'.$category_name.'</a></td>'
			.'<td align="right">'.number_format($amount,2).' &euro;</td>';
	if(!empty($st_budget)) {
		$s_out .= '<td align="right" style="color: '.$budget_color.';">'.$budget_amount.' &euro;</td>';
		$budget_total = $budget_total + $budget_amount;
	}
	$s_out .= '</tr>';
}
$s_out .= '<tr><td><B>TOTAL</B></td><td align="right"><B>'.number_format($total,2).' &euro;</B></td>';
if (!empty($st_budget)) {
	$budget_color = ($budget_total <= $total) ? '#FF0000' : '#00FF00';
	$s_out .= '<td align="right" style="color: '.$budget_color.';">'.number_format($budget_total,2).' &euro;</td>';
}
$s_out .= '</tr></table>';
$s_jsonData = "[".implode(",", $st_jsonData)."]";
?>

<script type="text/javascript">
	var pieData = <?php echo $s_jsonData; ?>;
	var pieTitle = "<?php echo $st_lang['expenses_monthly']; ?>";
	var barChartData = <?php echo $this->month_expenses; ?>;
	var barTitle = "<?php echo $st_lang['expenses_by_months']; ?>";
</script>

<?php
echo $s_out;
?>
