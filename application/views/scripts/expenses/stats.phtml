<!-- Graphic -->
<?php
global $st_lang;
$st_budget = $this->budget;

$s_out = '<center><table width = 350>
<tr><td></td><td align="right">'.$st_lang['expenses_expended'].'</td>';
if (!empty($st_budget)) $s_out .= '<td width=50>&nbsp;</td><td align="right">'.$st_lang['expenses_budget'].'</td></tr>';

$st_jsonData = array();
$current = 0;
$total = 0;
$budget_total = 0;
$i_rootPK = 0;
foreach ($this->expenses as $key => $data) {
	$amount = $data['sum(e.amount)'];
	$current = $data['id'];
	$category_name = $data['name'];
	$total = $total + $amount;
	$st_jsonData[] = "['".$category_name."', ".$amount."]";
	$budget_amount = (isset($st_budget[$data['id']])) ? $st_budget[$data['id']] : 0;
	$budget_color = ($budget_amount <= $amount) ? '#FF0000' : '#00FF00';
	$s_out .= '<tr><td>'.$category_name.'</td><td align="right">'.number_format($amount,2).' &euro;</td>';
	if(!empty($st_budget)) {
		$s_out .= '<td>&nbsp;</td><td align="right" style="color: '.$budget_color.';">'.$budget_amount.' &euro;</td>';
		$budget_total = $budget_total + $budget_amount;
	}
	$s_out .= '</tr>';
}
$s_out .= '<tr><td><B>TOTAL</B></td><td align="right"><B>'.number_format($total,2).' &euro;</B></td>';
if (!empty($st_budget)) {
	$budget_color = ($budget_total <= $total) ? '#FF0000' : '#00FF00';
	$s_out .= '<td>&nbsp;</td><td align="right" style="color: '.$budget_color.';">'.number_format($budget_total,2).' &euro;</td>';
}
$s_out .= '</tr></table></center>';
$s_jsonData = "[".implode(",", $st_jsonData)."]";
?>
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script type="text/javascript">
	var chart;
	// Load the Visualization API and the piechart package.
	google.load('visualization', '1.0', {'packages':['corechart']});
	// Set a callback to run when the Google Visualization API is loaded.
	google.setOnLoadCallback(drawChart);
	// Callback function
	function drawChart() {
		// Create the data table.
		var data = new google.visualization.DataTable();
        data.addColumn('string', 'Category');
        data.addColumn('number', '€');
        data.addRows(<?php echo $s_jsonData; ?>);
        var formatter = new google.visualization.NumberFormat(
        		{suffix: ' €', negativeColor: 'red', negativeParens: true}
        );
        formatter.format(data, 1);
        // Set chart options
        var options = {'title':'Month expense', 'width':500, 'height':300};
        // Instantiate and draw our chart, passing in some options.
        chart = new google.visualization.PieChart(document.getElementById('expenses_month'));
        // TODO: Add listener for category_filter
        google.visualization.events.addListener(chart, 'select', function() {
            var filter = data.getValue(chart.getSelection()[0].row, 0);
            console.log(filter);
            $('#category_filter').find('option[text="'+filter+'"]').attr('selected', true);
        });
        chart.draw(data, options);
	}
</script>
<div id="expenses_month"></div>
<br><br>
<?php
echo $s_out;
print_r($this->form_sent);
?>
<br></br><br></br>
<!-- Graphic -->
<div id="expenses_all">
<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="http://fpdownload.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=8,0,0,0" width="300" height="300" id="graph-2" align="middle">
<param name="allowScriptAccess" value="sameDomain" />
<param name="movie" value="<?php echo Zend_Registry::get('config')->moxie->settings->url; ?>/application/3rdparty/ofc/open-flash-chart.swf?width=150&height=250&data=<?php echo Zend_Registry::get('config')->moxie->settings->url; ?>/stats/stats/mydata/user:<?php echo $_SESSION['user_id']; ?>" />
<param name="quality" value="high" />
<param name="bgcolor" value="#FFFFFF" />
<embed src="<?php echo Zend_Registry::get('config')->moxie->settings->url; ?>/application/3rdparty/ofc/open-flash-chart.swf?width=150&height=250&data=<?php echo Zend_Registry::get('config')->moxie->settings->url; ?>/stats/stats/mydata/user:<?php echo $_SESSION['user_id']; ?>" quality="high" bgcolor="#FFFFFF" width="500" height="250" name="open-flash-chart" align="middle" allowScriptAccess="sameDomain" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" />
</object>
</div>