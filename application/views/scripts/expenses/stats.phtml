<!-- Graphic -->
<?php
global $st_lang;
$st_budget = $this->budget;

$s_out = '<center><table width = 350>
<tr><td></td><td align="right">'.$st_lang['expenses_expended'].'</td>';
if (!empty($st_budget)) $s_out .= '<td width=50>&nbsp;</td><td align="right">'.$st_lang['expenses_budget'].'</td></tr>';

$st_jsonData = array();
$current = 0;
$total = 0;
$budget_total = 0;
$i_rootPK = 0;
foreach ($this->expenses as $key => $data) {
	$amount = $data['sum(e.amount)'];
	$current = $data['id'];
	$category_name = $data['name'];
	$total = $total + $amount;
	$st_jsonData[] = "['".$category_name."', ".$amount."]";
	$budget_amount = (isset($st_budget[$data['id']])) ? $st_budget[$data['id']] : 0;
	$budget_color = ($budget_amount <= $amount) ? '#FF0000' : '#00FF00';
	$s_out .= '<tr><td>'.$category_name.'</td><td align="right">'.number_format($amount,2).' &euro;</td>';
	if(!empty($st_budget)) {
		$s_out .= '<td>&nbsp;</td><td align="right" style="color: '.$budget_color.';">'.$budget_amount.' &euro;</td>';
		$budget_total = $budget_total + $budget_amount;
	}
	$s_out .= '</tr>';
}
$s_out .= '<tr><td><B>TOTAL</B></td><td align="right"><B>'.number_format($total,2).' &euro;</B></td>';
if (!empty($st_budget)) {
	$budget_color = ($budget_total <= $total) ? '#FF0000' : '#00FF00';
	$s_out .= '<td>&nbsp;</td><td align="right" style="color: '.$budget_color.';">'.number_format($budget_total,2).' &euro;</td>';
}
$s_out .= '</tr></table></center>';
$s_jsonData = "[".implode(",", $st_jsonData)."]";
error_log("received: ".$this->month_expenses);
?>
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script type="text/javascript">
	var barChartData = <?php echo $this->month_expenses; ?>;
	var barTitle = "<?php echo $this->month_expenses_label; ?>";
	var chart;
	// Load the Visualization API and the piechart package.
	google.load('visualization', '1.0', {'packages':['corechart']});
	// Set a callback to run when the Google Visualization API is loaded.
	google.setOnLoadCallback(drawChart);
	// Callback function
	function drawChart() {
		// Create the data table.
		var data = new google.visualization.DataTable();
        data.addColumn('string', 'Category');
        data.addColumn('number', '€');
        data.addRows(<?php echo $s_jsonData; ?>);
        var formatter = new google.visualization.NumberFormat(
        		{suffix: ' €', negativeColor: 'red', negativeParens: true}
        );
        formatter.format(data, 1);
        // Set chart options
        var options = {'title':'Month expense', 'width':500, 'height':300};
        // Instantiate and draw our chart, passing in some options.
        chart = new google.visualization.PieChart(document.getElementById('expenses_month'));
        // TODO: Add listener for category_filter
        google.visualization.events.addListener(chart, 'select', function() {
            var filter = data.getValue(chart.getSelection()[0].row, 0);
            console.log(filter);
            $('#category_filter').find('option[text="'+filter+'"]').attr('selected', true);
        });
        chart.draw(data, options);


        var data2 = google.visualization.arrayToDataTable(barChartData);

		var options2 = {
			title: barTitle,
			hAxis: {title: 'Year', titleTextStyle: {color: 'red'}}
		};

		var chart2 = new google.visualization.ColumnChart(document.getElementById('expenses_all'));
		chart2.draw(data2, options2);
	}
</script>
<div id="expenses_month"></div>
<br><br>
<?php
echo $s_out;
print_r($this->form_sent);
?>
<br></br><br></br>
<!-- Graphic -->
<div id="expenses_all">
</div>