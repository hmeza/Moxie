<!DOCTYPE html
PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Expenses</title>
<script type="text/javascript" language="text/javascript">
	var year = <?php echo $this->year; ?>;
	var month = <?php echo $this->month; ?>;
	function markAll(option) {
		window.location="/expenses/markall/option/"+option+"/year/"+year+"/month/"+month;
	}

	function markLine(id) {
		window.location="/expenses/markline/id/"+id;
	}
</script>

</head>
<body>

    <h2>Categories controller</h2>
<table width=100%>
<!-- Form + expenses list --> 
<tr>
<td>
<a href="/expenses/index/month/<?php if ($this->month == 1) echo 12; else echo $this->month-1;?>/year/<?php if ($this->month == 1) echo $this->year-1; else echo $this->year;?>">Last</a>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<a href="/expenses/index/month/<?php if ($this->month == 12) echo 1; else echo $this->month+1;?>/year/<?php if ($this->month == 12) echo $this->year+1; else echo $this->year;?>">Next</a>
<?php
echo $this->form;
?>
<pre>
<?php
$f_totalAmount = 0;
echo '
<table border=1 width=600>
<td colspan=6>
Marcar:&nbsp;
<span onClick="markAll(0);" alt="Desmarcar todos" title="Desmarcar todos">Ninguno</span>&nbsp;
<span onClick="markAll(1);" alt="Marcar todos" title="Marcar todos">Todos</span>
</td>
';

foreach ($this->list as $key=>$value) {
	$checked = ($value['in_sum'] == '1') ? "checked":"";
	$s_dateGet = (isset($this->month) && isset($this->year)) ? '/year/'.$this->year.'/month/'.$this->month : '';
	echo '<tr>';
	echo '<td><input type="checkbox" id="'.$value['id'].'" name="'.$value['id'].'" onClick="markLine('.$value['id'].');" '.$checked.'></td>';
	echo '<td><a href="/expenses/delete/id/'.$value['id'].$s_dateGet.'">X</a>&nbsp;<a href="/expenses/edit/id/'.$value['id'].$s_dateGet.'">E</a></td>'
	.'<td>'.$value['amount'].' &euro;</td>';
	echo '<td>'.$value['expense_date'].'</td>';
	echo '<td><div alt="'.$value['description'].'" title="'.$value['description'].'">'.$value['name'].'</div></td>';
	echo '<td width=200>'.$value['note'].'</td>';
	echo '</tr>';
	$f_totalAmount = $f_totalAmount + $value['amount'];
}
echo '<tr>
<td colspan=2></td>
<td>'.number_format($f_totalAmount,2).' &euro;</td><td colspan=3></td></tr>
</table>
';
?>
</pre>
</td>
<td align="center" valign="top">
<!-- Graphic -->
<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="http://fpdownload.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=8,0,0,0" width="300" height="300" id="graph-2" align="middle">
<param name="allowScriptAccess" value="sameDomain" />
<param name="movie" value="http://moxie.dev/open-flash-chart.swf?width=150&height=250&data=http://moxie.dev/data.php?month=<?php echo $this->month; ?>&year=<?php echo $this->year; ?>" />
<param name="quality" value="high" />
<param name="bgcolor" value="#FFFFFF" />
<embed src="http://moxie.dev/open-flash-chart.swf?width=150&height=250&data=http://moxie.dev/data.php?month=<?php echo $this->month; ?>&year=<?php echo $this->year; ?>" quality="high" bgcolor="#FFFFFF" width="500" height="250" name="open-flash-chart" align="middle" allowScriptAccess="sameDomain" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" />
</object>
<?php
//require_once 'open-flash-chart-1.9.7/php-ofc-library/open_flash_chart_object.php';
//open_flash_chart_object( 500, 250, 'http://'. $_SERVER['SERVER_NAME'] .'/data.php', false );

mysql_connect("127.0.0.1","root","0nr3fn1");
mysql_select_db("moxie");

$sql = "select c0.id as parent_id, c.id as id, c.name as name,c2.id as son_id,sum(e.amount) from expenses e, categories c left join categories c2 on c.id = c2.parent left join categories c0 on c0.id = c.parent "
	." where (c.id = e.category or c2.id = e.category) and YEAR(e.expense_date) = ".$this->year." AND MONTH(e.expense_date) = ".$this->month." and e.in_sum = 1 group by (c.id) order by c.id, c2.id";
$rows = mysql_query($sql);

echo '<table width = 250>';
$current = 0;
$total = 0;
while ($data = mysql_fetch_array($rows)) {
	$parent = $data[1];
	if ($data[1] != 1) {
		$amount = $data[4];
		if ($data[0] == $current) {
			$category_parent = "";
			$category_current = $data[2];
		}
		else {
			$current = $data[1];
			$category_parent = $data[2];
			$category_current = "";
		}
		if ($data[0] == 1) $total = $total + $amount;
		echo '<tr><td>'.$category_parent.'</td><td>'.$category_current.'</td><td align="right">'.number_format($amount,2).' &euro;</td></tr>';
	}
}
echo '<tr><td colspan=2><B>TOTAL</B></td><td align="right"><B>'.number_format($total,2).' &euro;</B></td></tr>';
echo '</table>';
mysql_free_result($rows);

print_r($this->form_sent);
?>
</td>
</tr>
</table>
</body>
</html>