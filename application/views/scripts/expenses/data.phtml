<script type="text/javascript" src="/js/jquery.js"></script>
<script type="text/javascript" language="text/javascript">
	function confirmDelete(id) {
		var response;
		var name;
		var delete_success;
		var new_value = 0;
		var deleted_value = 0;

		response = confirm("Are you sure to delete this expense?");
		if (response == true) {
			name = id.split("/");
			$.ajax({
				type: "GET",
				data: "",
				url: "<?php echo Zend_Registry::get('config')->moxie->settings->url; ?>/expenses/dodelete/id/"+id,
			});

			new_value = $("#total").html().replace(" &euro;", "").replace(" €", "");
			deleted_value = id.split("/");
			deleted_value = deleted_value[0];
			deleted_value = $("#val"+deleted_value).html().replace(" &euro;", "").replace(" €", "");
			new_value = parseFloat(new_value) - parseFloat(deleted_value);
			$("#total").html(new_value.toFixed(2)+" &euro;");
			$("#tr"+name[0]).toggle(1000);

			$.ajax({
				type: "GET",
				url: "<?php echo Zend_Registry::get('config')->moxie->settings->url; ?>/expenses/year"
			}).done(function(data) {
				barChartData = eval(data);
				$.ajax({
					type: "GET",
					url: "<?php echo Zend_Registry::get('config')->moxie->settings->url; ?>/expenses/month/month/"+<?php echo (isset($this->month) ? $this->month : date('n')); ?>+"/year/"+<?php echo $this->year; ?>
				}).done(function(data) {
					pieData = eval(data);
					drawChart();
				});
			});
		}
	}
</script>
<table>
<td><a href="/expenses/index/month/<?php if ($this->month == 1) echo 12; else echo $this->month-1;?>/year/<?php if ($this->month == 1) echo $this->year-1; else echo $this->year;?>"><div class="moxieicon moxieprevious"></div></a></td>
<td><a href="/expenses/index/month/<?php if ($this->month == 12) echo 1; else echo $this->month+1;?>/year/<?php if ($this->month == 12) echo $this->year+1; else echo $this->year;?>"><div class="moxieicon moxienext"></div></a></td>
</table>
<?php
$i_expensePK = $this->form->getElement('id');
if (isset($i_expensePK)) {
	echo '<form id="login" enctype="application/x-www-form-urlencoded" action="/expenses/update" method="post">';
	echo $this->form->getElement('user_owner');
	echo $this->form->getElement('id');
}
else {
	echo '<form id="login" enctype="application/x-www-form-urlencoded" action="/expenses/add" method="post">';
}
echo $this->form->getElement('amount');
echo $this->form->getElement('category');
echo "\n";
echo $this->form->getElement('note');
echo '<div class="date">'.$this->form->getValue('date').'</div>';
echo $this->form->getElement('submit');
echo '</form>';

global $st_lang;
$f_totalAmount = 0;
echo '
<table border=1 width=600 class="list moxie" id="mytable">
<tr>
<td colspan=5>
'.$st_lang['expenses_mark'].'
<span onClick="markAll(0);" alt="'.$st_lang['expenses_unmark_all'].'" title="'.$st_lang['expenses_unmark_all'].'" style="cursor:hand; cursor:pointer">'.$st_lang['expenses_none'].'</span>&nbsp;
<span onClick="markAll(1);" alt="'.$st_lang['expenses_mark_all'].'" title="'.$st_lang['expenses_mark_all'].'" style="cursor:hand; cursor:pointer">'.$st_lang['expenses_all'].'</span>&nbsp;&nbsp;&nbsp;
</td>
<td colspan=2 align=right>
Filtrar por <select id="category_filter" onchange="filter();">
<option value="0">---</option>
';
foreach ($this->form->getElement('category') as $key => $value) {
	if ($key == "options") {
		foreach ($value as $key2 => $value2) {
			echo '<option value="'.$key2.'">'.$value2.'</option>';
		}
	}
}

echo '
</select>
</td>
</tr>
';

foreach ($this->list as $key=>$value) {
	$checked = ($value['in_sum'] == '1') ? "checked":"";
	$s_dateGet = (isset($this->month) && isset($this->year)) ? '/year/'.$this->year.'/month/'.$this->month : '';
	$st_expenseDate = explode(' ',$value['expense_date']);
	$expense_date = '<span alt="'.$st_expenseDate[1].'" title="'.$st_expenseDate[1].'">'.$st_expenseDate[0].'</span>';
	
	echo '
<tr id="tr'.$value['id'].'">
<td class="list" width="10"><input type="checkbox" class="my-checkbox" id="'.$value['id'].'" name="'.$value['id'].'" onClick="markLine('.$value['id'].');" '.$checked.'></td>
<td class="list" width="16"><div id="del'.$value['id'].'" class="moxieicon moxiedelete" onclick=\'confirmDelete("'.$value['id'].$s_dateGet.'")\'></div></td>
<td class="list" width="16"><a class="moxieedit" href="/expenses/edit/id/'.$value['id'].$s_dateGet.'"><div class="moxieicon moxieedit"></div></a></td>'
.'<td align="right" class="list" width="100"><span id="val'.$value['id'].'">'.number_format($value['amount'],2).' &euro;</span></td>
<td width="100" align="center" class="list">'.$expense_date.'</td>
<td class="list" width="80"><div alt="'.$value['description'].'" title="'.$value['description'].'">'.$value['name'].'</div></td>
<td class="list">'.$value['note'].'</td>
</tr>';
	$f_totalAmount = $f_totalAmount + $value['amount'];
}
echo '<tr>
<td colspan=3></td>
<td align="right" class="list"><span id="total">'.number_format($f_totalAmount,2).' &euro;</span></td><td colspan=3></td>
</tr>
</table>
';
?>
