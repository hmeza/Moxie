<script type="text/javascript">
<?php
global $st_lang;

$s_budget = "var budgets = new Array();\n";
$s_categories = array();
foreach ($this->budget as $key => $value) {
	$s_budget .= "budgets[".$key."] = new Array();\n";
	foreach ($value as $inner_key => $inner_value) {
		$s_budget .= "budgets[".$key."][".$inner_key."] = ".$inner_value.";\n";
		if(!in_array($inner_key, $s_categories)) {
			$s_categories[] = $inner_key;
		}
	}
}
echo $s_budget;

?>
var categories = [<?php echo implode(',', $s_categories);?>];
function onmouseoverchange(month) {
	for (category in categories) {
		$("#budget"+category).html((budgets[month][categories[category]].toFixed(2))+" &euro;");
	}
}

function onmouseoutchange() {
	for (category in categories) {
		$("#budget"+category).html((budgets[<?php echo date('m'); ?>][categories[category]].toFixed(2))+" &euro;");
	}
}

$(document).ready(function() {
    $("#show_stats").click(
		function(event) {
    		$("#box").slideToggle();
		}
	);
    $("#show_budget").click(
    		function(event) {
        		$("#budget").slideToggle();
    		}
    	);
	$("#caja").click(function(event) {
	    $("#box").slideUp();
	});
	$("[name^='month']").mouseover(function() {
		var monthId = $(this).attr('name').replace('month', '');
		onmouseoverchange(monthId);
	});
	$("[name^='month']").mouseout(function() {
		var monthId = $(this).attr('name').replace('month', '');
		onmouseoutchange(monthId);
	});
});

</script>

<h2><span id="show_budget"><?php echo $st_lang['stats_budget_title']; ?></span></h2>
<div id="budget">
<table width=100% style="font-size: 11px;">
<th></th>
<?php
$income = array();
$expense = array();
$balance = 0;
for ($month = 1; $month <= 12; $month++) {
	$income[$month] = 0;
	$expense[$month] = 0;
	echo '<th align="right"><a href="/expenses/index/month/'.$month.'/year/'.date('Y').'">'.date('M',mktime(1,1,1,$month,1,date('Y'))).'</a></th>';
}
if (!empty($this->budget)) {
	echo '<th align="right"><a href="/categories/index">'.$st_lang['budget'].'</a></th>';
	$i_colspan = 14;
}
else {
	$i_colspan = 13;
}
echo '<tr>';
foreach ($this->budget_incomes as $key => $category) {
	echo '<td>'.$category.'</td>';
	for ($month = 1; $month <= 12; $month++) {
		$current_income = 0;
		foreach ($this->incomes[$month] as $income_key => $value) {
			if ($value['category'] == $key) $current_income += $value['amount'];
		}
		$income[$month] += $current_income;
		echo '<td align="right">'.number_format($current_income,2).' &euro;</td>';
	}
	if (!empty($this->budget)) echo '<td></td>';
	echo '<tr>';
}
echo '<th align="left">'.$st_lang['stats_budget_income'].'</th>';
for ($month = 1; $month <= 12; $month++) {
	echo '<th align="right">'.number_format($income[$month],2).' &euro;</th>';
}
if (!empty($this->budget)) echo '<th></th>';
echo '<tr>';
echo '<td colspan='.$i_colspan.'>&nbsp;</td><tr>';

foreach ($this->budget_expenses as $key => $category) {
	echo '<td>'.$category.'</td>';
	for ($month = 1; $month <= 12; $month++) {
		$current_expense = 0;
		foreach ($this->expenses[$month] as $expense_key => $value) {
			if ($value['category'] == $key) $current_expense += $value['amount'];
		}
		$expense[$month] += $current_expense;
		if (!empty($this->budget)) {
			if (!isset($this->budget[$month][$key])) {
				// search for this key in forward months
				for ($i = $month+1; $i < 13; $i++) {
					if (isset($this->budget[$i][$key]))
						$this->budget[$month][$key] = $this->budget[$i][$key];
				}
				// if still unset...
				if (!isset($this->budget[$month][$key]))
					$this->budget[$month][$key] = $current_expense;
			}
			$s_color = ($current_expense > $this->budget[$month][$key]) ?
				' style="color: #FF0000"' : ' style="color: #000000"';
		}
		else {
			$s_color = '';
		}
		echo '<td align="right"'.$s_color.' name="month'.$month.'">'.number_format($current_expense,2).' &euro;</td>';
	}
	if (!empty($this->budget)) {
		$i_budget = (!empty($this->budget[date('m')][$key])) ? $this->budget[date('m')][$key] : 0;
		echo '<td align="right" style="color: #00FF00" id="budget'.$key.'">'.number_format($i_budget,2).' &euro;</td>';
	}
	echo '<tr>';
}
echo '<th align="left">'.$st_lang['stats_budget_expense'].'</th>';
for ($month = 1; $month <= 12; $month++) {
	echo '<th align="right">';
	echo '<a href="/expenses/index/month/'.$month.'/year/'.date('Y').'">';
	echo number_format($expense[$month],2);
	echo ' &euro;</a></th>';
}
if (!empty($this->budget)) echo '<th></th>';
echo '<tr>';
echo '<td colspan='.$i_colspan.'>&nbsp;</td><tr>';

echo '<th align="left">'.$st_lang['stats_budget_total'].'</th>';
for ($month = 1; $month <= 12; $month++) {
	echo '<th align="right">'.number_format(($income[$month]-$expense[$month]),2).' &euro;</th>';
	$balance += ($income[$month]-$expense[$month]);
}
echo '<th align="right">'.number_format($balance,2).' &euro;</th>
</tr>';
?>
</table>
</div>
<br></br>
<h2><span id="show_stats"><?php echo $st_lang['stats_title']; ?></span></h2>
<div id="box">
<table width=100%>
<tr>
<th align="left"><?= $st_lang['category']; ?></th>
<th align="right"><?= $st_lang['total']; ?></th>
<th align="right"><?= $st_lang['total_this_year']; ?></th>
<th align="right"><?= $st_lang['average_this_year']; ?></th>
<th align="right"><?= $st_lang['average_unit']; ?></th>
</tr>
<?php
foreach ($this->data as $key => $value) {
	$i_currentMonth = date('m');
	echo '<tr>
	<td>'.$value['name'].'</td>
	<td align="right">'.number_format($value['sumtotal'],2).' &euro;</td>
	<td align="right">'.number_format($value['sumyear'],2).' &euro;</td>
	<td align="right">'.number_format($value['sumyear']/$i_currentMonth,2).' &euro;</td>
	<td align="right">'.number_format($value['avgyear'],2).' &euro;</td>
	</tr>';
}
?>
</table>
</div>
