<!DOCTYPE html
PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title><?php global $st_lang; echo $st_lang['stats']; ?></title>
<link rel="stylesheet" type="text/css" href="../../../moxie.css"/>
<script type="text/javascript" src="/js/jquery.js"></script>
<script type="text/javascript">
$(document).ready(function() {
    $("#show_stats").click(
		function(event) {
    		$("#box").slideToggle();
		}
	);
    $("#show_budget").click(
    		function(event) {
        		$("#budget").slideToggle();
    		}
    	);
$("#caja").click(function(event) {
    $("#box").slideUp();
});
});
</script>
</head>

<body>
<h2><span id="show_budget"><?php echo $st_lang['stats_budget_title']; ?></span></h2>
<div id="budget">
<table width=100% style="font-size: 11px;">
<th></th>
<?php
$income = array();
$expense = array();
if (!empty($this->budget)) {
	echo '<th align="right">'.$st_lang['budget'].'</th>';
	$i_colspan = 14;
}
else {
	$i_colspan = 13;
}
for ($month = 1; $month <= 12; $month++) {
	$income[$month] = 0;
	$expense[$month] = 0;
}
for ($month = 1; $month <= 12; $month++) echo '<th align="right">'.date('M',mktime(1,1,1,$month,1,date('Y'))).'</th>';
echo '<tr>';
foreach ($this->budget_incomes as $key => $category) {
	echo '<td>'.$category.'</td>';
	if (!empty($this->budget)) echo '<td></td>';
	for ($month = 1; $month <= 12; $month++) {
		$current_income = 0;
		foreach ($this->incomes[$month] as $income_key => $value) {
			if ($value['category'] == $key) $current_income += $value['amount'];
		}
		$income[$month] += $current_income;
		echo '<td align="right">'.number_format($current_income,2).' &euro;</td>';
	}
	echo '<tr>';
}
echo '<th align="left">'.$st_lang['stats_budget_income'].'</th>';
if (!empty($this->budget)) echo '<th></th>';
for ($month = 1; $month <= 12; $month++) {
	echo '<th align="right">'.number_format($income[$month],2).' &euro;</th>';
}
echo '<tr>';
echo '<td colspan='.$i_colspan.'>&nbsp;</td><tr>';

foreach ($this->budget_expenses as $key => $category) {
	echo '<td>'.$category.'</td>';
	if (!empty($this->budget)) {
		$i_budget = (!empty($this->budget[$key])) ? $this->budget[$key] : 0;
		echo '<td align="right" style="color: #00FF00">'.number_format($i_budget,2).' &euro;</td>';
	}
	for ($month = 1; $month <= 12; $month++) {
		$current_expense = 0;
		foreach ($this->expenses[$month] as $expense_key => $value) {
			if ($value['category'] == $key) $current_expense += $value['amount'];
		}
		$expense[$month] += $current_expense;
		if (!empty($this->budget)) {
			if ($current_expense > $this->budget[$key]) {
				$s_color = ' style="color: #FF0000"';
			}
			else {
				//$s_color = ' style="color: #00FF00"';
				$s_color = ' style="color: #000000"';
			}
		}
		else {
			$s_color = '';
		}
		echo '<td align="right"'.$s_color.'>'.number_format($current_expense,2).' &euro;</td>';
	}
	echo '<tr>';
}
echo '<th align="left">'.$st_lang['stats_budget_expense'].'</th>';
if (!empty($this->budget)) echo '<th></th>';
for ($month = 1; $month <= 12; $month++) {
	echo '<th align="right">';
	echo '<a href="/expenses/index/month/'.$month.'/year/'.date('Y').'">';
	echo number_format($expense[$month],2);
	echo ' &euro;</a></th>';
}
echo '<tr>';
echo '<td colspan='.$i_colspan.'>&nbsp;</td><tr>';

echo '<th align="left">'.$st_lang['stats_budget_total'].'</th>';
if (!empty($this->budget)) echo '<th></th>';
for ($month = 1; $month <= 12; $month++) {
	echo '<th align="right">'.number_format(($income[$month]-$expense[$month]),2).' &euro;</th>';
}
?>
</table>
</div>
<br></br>
<h2><span id="show_stats"><?php echo $st_lang['stats_title']; ?></span></h2>
<div id="box">
<table width=100%>
<tr>
<th align="left"><?= $st_lang['category']; ?></th>
<th align="right"><?= $st_lang['total']; ?></th>
<th align="right"><?= $st_lang['total_this_year']; ?></th>
<th align="right"><?= $st_lang['average_this_year']; ?></th>
<th align="right"><?= $st_lang['average_unit']; ?></th>
</tr>
<?php
foreach ($this->data as $key => $value) {
	$i_currentMonth = date('m');
	echo '<tr>
	<td>'.$value['name'].'</td>
	<td align="right">'.number_format($value['sumtotal'],2).' &euro;</td>
	<td align="right">'.number_format($value['sumyear'],2).' &euro;</td>
	<td align="right">'.number_format($value['sumyear']/$i_currentMonth,2).' &euro;</td>
	<td align="right">'.number_format($value['avgyear'],2).' &euro;</td>
	</tr>';
}
?>
</table>
</div>
</body>
</html>